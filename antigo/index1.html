import React, { useState, useEffect } from 'react';
import { Clock, CheckCircle2, Calendar, Dumbbell, Flame, Info, PlayCircle, History as HistoryIcon, Save, Trash2, ArrowLeft, Timer, Play } from 'lucide-react';

// Definição dos dados do treino
const workoutData = {
  segunda: {
    title: "Segunda: Empurrar",
    focus: "Largura de tronco (Peito/Ombro/Tríceps)",
    exercises: [
      { name: "Supino Inclinado (Halteres ou Barra)", sets: 4, reps: "10-12", obs: "" },
      { name: "Crucifixo Máquina (Peck Deck)", sets: 3, reps: "12-15", obs: "Bi-set com Flexão" },
      { name: "Flexão de Braço", sets: 3, reps: "Falha", obs: "Bi-set com Crucifixo" },
      { name: "Desenvolvimento Militar", sets: 4, reps: "10-12", obs: "Sentado ou em pé" },
      { name: "Elevação Lateral", sets: 4, reps: "15", obs: "Foco total na lateral" },
      { name: "Tríceps Corda", sets: 3, reps: "12-15", obs: "Bi-set com Francês" },
      { name: "Tríceps Francês", sets: 3, reps: "12-15", obs: "Bi-set com Corda" },
      { name: "Abdominal Infra", sets: 4, reps: "15-20", obs: "Elevação de pernas" }
    ]
  },
  terca: {
    title: "Terça: Puxar",
    focus: "Postura e formato em V (Costas/Bíceps)",
    exercises: [
      { name: "Puxada Alta", sets: 4, reps: "10-12", obs: "Pegada aberta" },
      { name: "Remada Baixa (Triângulo)", sets: 4, reps: "12", obs: "Segure 1s na contração" },
      { name: "Face Pull", sets: 3, reps: "15", obs: "Essencial para postura" },
      { name: "Crucifixo Inverso", sets: 3, reps: "12-15", obs: "Halteres ou Máquina" },
      { name: "Rosca Direta", sets: 4, reps: "10-12", obs: "Barra W ou Reta" },
      { name: "Rosca Martelo", sets: 3, reps: "12-15", obs: "Preencher braço" }
    ]
  },
  quarta: {
    title: "Quarta: Pernas (Anterior)",
    focus: "Quadríceps - Alta demanda",
    exercises: [
      { name: "Agachamento Livre ou Hack", sets: 4, reps: "10-12", obs: "" },
      { name: "Leg Press 45º", sets: 4, reps: "12-15", obs: "Pés baixos na plataforma" },
      { name: "Cadeira Extensora", sets: 3, reps: "15", obs: "Drop-set na última série" },
      { name: "Afundo ou Passada", sets: 3, reps: "12 cada", obs: "Com halteres" },
      { name: "Panturrilha no Leg/Sentado", sets: 5, reps: "15-20", obs: "" }
    ]
  },
  quinta: {
    title: "Quinta: Upper Body",
    focus: "Metabólico / Pump",
    exercises: [
      { name: "Supino Reto", sets: 4, reps: "10-12", obs: "Bi-set com Remada" },
      { name: "Remada Curvada", sets: 4, reps: "10-12", obs: "Bi-set com Supino" },
      { name: "Desenvolvimento Halteres", sets: 3, reps: "12", obs: "Bi-set com Puxada" },
      { name: "Puxada Alta Supinada", sets: 3, reps: "12", obs: "Bi-set com Desenv." },
      { name: "Elevação Lateral", sets: 3, reps: "12-15", obs: "Bi-set com Frontal" },
      { name: "Elevação Frontal", sets: 3, reps: "12-15", obs: "Bi-set com Lateral" },
      { name: "Rosca Scott", sets: 3, reps: "12", obs: "Super-série braços" },
      { name: "Tríceps Testa", sets: 3, reps: "12", obs: "Super-série braços" },
      { name: "Prancha Abdominal", sets: 4, reps: "1 min", obs: "Ou até a falha" }
    ]
  },
  sexta: {
    title: "Sexta: Pernas (Posterior)",
    focus: "Posterior e Glúteo",
    exercises: [
      { name: "Levantamento Terra/Stiff", sets: 4, reps: "8-10", obs: "Carga moderada, técnica" },
      { name: "Mesa Flexora", sets: 4, reps: "12-15", obs: "" },
      { name: "Cadeira Flexora/Nórdica", sets: 3, reps: "Falha", obs: "" },
      { name: "Elevação Pélvica", sets: 4, reps: "12", obs: "Contração de glúteo no topo" },
      { name: "Panturrilha em Pé", sets: 4, reps: "15", obs: "" }
    ]
  }
};

const profile = {
  nome: "Treino Slim/Definição",
  horario: "12:00 - 13:20",
  meta: "Massa Magra + Perda de Gordura",
  cardio: "Sáb/Dom: Pedalada (40-60min)"
};

export default function App() {
  const [activeTab, setActiveTab] = useState('segunda');
  const [view, setView] = useState('workout'); // 'workout' or 'history'
  const [timeLeft, setTimeLeft] = useState(60);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [completedSets, setCompletedSets] = useState({});
  const [history, setHistory] = useState([]);
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const [elapsedString, setElapsedString] = useState("00:00");

  // Carregar dados salvos
  useEffect(() => {
    const savedProgress = localStorage.getItem('slim_workout_progress');
    const savedHistory = localStorage.getItem('slim_workout_history');
    const savedStartTime = localStorage.getItem('slim_workout_start_time');

    if (savedProgress) setCompletedSets(JSON.parse(savedProgress));
    if (savedHistory) setHistory(JSON.parse(savedHistory));
    
    // Lógica de tempo de treino: Só recupera se existir (não inicia automático)
    const now = Date.now();
    if (savedStartTime && (now - parseInt(savedStartTime) < 12 * 60 * 60 * 1000)) { // Aumentei janela para 12h
       setSessionStartTime(parseInt(savedStartTime));
    } else {
       // Não inicia automático aqui
       setSessionStartTime(null);
    }
  }, []);

  // Atualizar cronômetro do treino atual
  useEffect(() => {
    if (!sessionStartTime) {
        setElapsedString("00:00");
        return;
    }

    const interval = setInterval(() => {
      const now = Date.now();
      const diff = now - sessionStartTime;
      
      const seconds = Math.floor((diff / 1000) % 60);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const hours = Math.floor(diff / (1000 * 60 * 60));

      const fmt = (num) => num.toString().padStart(2, '0');
      
      if (hours > 0) {
        setElapsedString(`${hours}:${fmt(minutes)}:${fmt(seconds)}`);
      } else {
        setElapsedString(`${fmt(minutes)}:${fmt(seconds)}`);
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [sessionStartTime]);

  // Salvar progresso
  useEffect(() => {
    if (Object.keys(completedSets).length > 0) {
      localStorage.setItem('slim_workout_progress', JSON.stringify(completedSets));
    }
  }, [completedSets]);

  // Salvar histórico
  useEffect(() => {
    localStorage.setItem('slim_workout_history', JSON.stringify(history));
  }, [history]);

  // Timer de descanso logic
  useEffect(() => {
    let interval = null;
    if (isTimerRunning && timeLeft > 0) {
      interval = setInterval(() => setTimeLeft((t) => t - 1), 1000);
    } else if (timeLeft === 0) {
      setIsTimerRunning(false);
    }
    return () => clearInterval(interval);
  }, [isTimerRunning, timeLeft]);

  const toggleTimer = () => {
    if (isTimerRunning) setIsTimerRunning(false);
    else {
      setTimeLeft(60);
      setIsTimerRunning(true);
    }
  };

  const resetTimer = () => {
    setIsTimerRunning(false);
    setTimeLeft(60);
  };

  const toggleSet = (day, exerciseIndex, setNumber) => {
    const key = `${day}-${exerciseIndex}-${setNumber}`;
    setCompletedSets(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const startWorkout = () => {
    const newStart = Date.now();
    setSessionStartTime(newStart);
    localStorage.setItem('slim_workout_start_time', newStart.toString());
  };

  const finishWorkout = () => {
    if (!sessionStartTime) {
        alert("Você precisa iniciar o cronômetro antes de finalizar o treino!");
        return;
    }
    
    const endTime = Date.now();
    const durationMs = endTime - sessionStartTime;
    const durationMin = Math.round(durationMs / 60000);
    const hours = Math.floor(durationMin / 60);
    const minutes = durationMin % 60;
    
    // Formatação mais bonita para o histórico
    let durationString = "";
    if (hours > 0) durationString += `${hours}h `;
    durationString += `${minutes}m`;
    if (durationMs < 60000) durationString = "< 1 min";

    const newEntry = {
      id: Date.now(),
      date: new Date().toLocaleDateString('pt-BR'),
      day: activeTab.charAt(0).toUpperCase() + activeTab.slice(1),
      duration: durationString,
      timestamp: endTime
    };

    setHistory([newEntry, ...history]);
    
    // Resetar sessão (mas manter progresso visual dos checks se o usuário quiser ver)
    localStorage.removeItem('slim_workout_start_time');
    setSessionStartTime(null);
    setElapsedString("00:00");
    
    setView('history');
  };

  const clearHistory = () => {
    if(confirm("Tem certeza que deseja apagar todo o histórico?")) {
      setHistory([]);
    }
  };
  
  const resetWeek = () => {
    if(confirm("Deseja desmarcar todos os exercícios da semana?")) {
        setCompletedSets({});
        localStorage.removeItem('slim_workout_progress');
    }
  }

  // View: Histórico
  if (view === 'history') {
    return (
      <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
         <div className="bg-slate-900 text-white p-6 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-10">
            <div className="flex items-center gap-3 mb-4">
              <button onClick={() => setView('workout')} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700">
                <ArrowLeft size={20} />
              </button>
              <h1 className="text-xl font-bold">Histórico de Treinos</h1>
            </div>
            <div className="flex justify-between items-end">
                <div className="text-sm text-slate-400">Total de treinos: <span className="text-white font-bold">{history.length}</span></div>
                <button onClick={clearHistory} className="text-red-400 text-xs flex items-center gap-1 px-3 py-1 bg-red-900/20 rounded-full border border-red-900/50">
                   <Trash2 size={12}/> Limpar
                </button>
            </div>
         </div>

         <div className="px-4 max-w-2xl mx-auto space-y-3">
            {history.length === 0 ? (
               <div className="text-center py-12 text-slate-400">
                  <HistoryIcon size={48} className="mx-auto mb-3 opacity-20" />
                  <p>Nenhum treino finalizado ainda.</p>
               </div>
            ) : (
               history.map((item) => (
                 <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500 flex justify-between items-center">
                    <div>
                       <div className="font-bold text-slate-800">{item.day}</div>
                       <div className="text-xs text-slate-500 flex items-center gap-1">
                          <Calendar size={12}/> {item.date}
                       </div>
                    </div>
                    <div className="text-right">
                       <div className="text-xs text-slate-400 uppercase font-bold">Duração</div>
                       <div className="text-lg font-mono font-bold text-emerald-600">{item.duration}</div>
                    </div>
                 </div>
               ))
            )}
         </div>
      </div>
    );
  }

  const currentWorkout = workoutData[activeTab];

  // View: Treino (Padrão)
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-24">
      {/* Header */}
      <div className="bg-slate-900 text-white p-6 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-20">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h1 className="text-xl font-bold">{profile.nome}</h1>
            <p className="text-slate-400 text-xs flex items-center gap-1 mt-1">
              <Clock size={12} /> {profile.horario}
            </p>
          </div>
          <div className="flex flex-col items-end gap-2">
             <button 
                onClick={() => setView('history')}
                className="bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 border border-slate-700 transition-colors"
             >
               <HistoryIcon size={14} /> Histórico
             </button>
          </div>
        </div>
        
        <div className="flex gap-2 text-xs overflow-x-auto pb-1 items-center">
             {!sessionStartTime ? (
                 <button 
                    onClick={startWorkout}
                    className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-full font-bold flex gap-2 items-center text-sm shadow-lg animate-bounce"
                 >
                    <Play size={16} fill="currentColor" /> INICIAR TREINO
                 </button>
             ) : (
                 <div className="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 whitespace-nowrap text-emerald-400 font-bold flex gap-2 items-center text-sm shadow-inner">
                    <Timer size={16} className="animate-pulse" />
                    <span>{elapsedString}</span>
                 </div>
             )}
             
             <div className="flex-1"></div>

             <button onClick={resetWeek} className="bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 whitespace-nowrap hover:bg-red-900/30 text-slate-300 hover:text-red-300 transition-colors">
                Resetar Semana
             </button>
        </div>
      </div>

      {/* Day Selector */}
      <div className="px-4 mb-6 overflow-x-auto no-scrollbar">
        <div className="flex gap-2 min-w-max">
          {Object.keys(workoutData).map((day) => (
            <button
              key={day}
              onClick={() => setActiveTab(day)}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                activeTab === day
                  ? 'bg-slate-900 text-white shadow-md transform scale-105'
                  : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-100'
              }`}
            >
              {day.charAt(0).toUpperCase() + day.slice(1)}
            </button>
          ))}
        </div>
      </div>

      {/* Main Content */}
      <div className="px-4 max-w-2xl mx-auto space-y-4">
        <div className="flex items-center gap-2 mb-2">
           <Dumbbell className="text-emerald-600" size={20} />
           <h2 className="font-bold text-lg text-slate-800">{currentWorkout.title}</h2>
        </div>
        <p className="text-sm text-slate-500 italic mb-4 border-l-4 border-emerald-500 pl-3">
          Objetivo: {currentWorkout.focus}
        </p>

        {currentWorkout.exercises.map((exercise, idx) => (
          <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
             {exercise.obs.includes("Bi-set") && (
                <div className="absolute top-0 right-0 bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                  BI-SET
                </div>
             )}
             
            <div className="flex justify-between items-start mb-3">
              <h3 className="font-bold text-slate-800 pr-8">{exercise.name}</h3>
            </div>

            <div className="flex items-center gap-4 text-sm text-slate-600 mb-3">
              <div className="bg-slate-100 px-2 py-1 rounded">
                <span className="font-bold text-slate-900">{exercise.sets}</span> Séries
              </div>
              <div className="bg-slate-100 px-2 py-1 rounded">
                <span className="font-bold text-slate-900">{exercise.reps}</span> Reps
              </div>
            </div>

            {exercise.obs && !exercise.obs.includes("Bi-set") && (
               <div className="flex items-start gap-1 text-xs text-slate-500 mb-3 bg-slate-50 p-2 rounded">
                 <Info size={12} className="mt-0.5 flex-shrink-0" />
                 {exercise.obs}
               </div>
            )}
             {exercise.obs && exercise.obs.includes("Bi-set") && (
               <div className="flex items-start gap-1 text-xs text-orange-600 mb-3 bg-orange-50 p-2 rounded">
                 <Flame size={12} className="mt-0.5 flex-shrink-0" />
                 {exercise.obs}
               </div>
            )}

            {/* Set Checkboxes */}
            <div className="flex gap-2 mt-2">
              {Array.from({ length: exercise.sets }).map((_, setIdx) => {
                const isDone = completedSets[`${activeTab}-${idx}-${setIdx}`];
                return (
                  <button
                    key={setIdx}
                    onClick={() => toggleSet(activeTab, idx, setIdx)}
                    className={`h-8 flex-1 rounded-md flex items-center justify-center transition-colors border ${
                      isDone 
                        ? 'bg-emerald-500 border-emerald-600 text-white' 
                        : 'bg-slate-50 border-slate-200 text-slate-300 hover:border-emerald-400'
                    }`}
                  >
                    {isDone ? <CheckCircle2 size={16} /> : <span className="text-xs font-bold">{setIdx + 1}</span>}
                  </button>
                );
              })}
            </div>

            {/* Link para Vídeo */}
            <a 
              href={`https://www.youtube.com/results?search_query=${encodeURIComponent(exercise.name + " execução correta")}`}
              target="_blank"
              rel="noopener noreferrer"
              className="mt-3 flex items-center justify-center gap-2 w-full py-2 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 transition-colors border border-slate-100"
            >
              <PlayCircle size={16} />
              Ver como fazer (YouTube)
            </a>

          </div>
        ))}
        
        {/* Finish Workout Button */}
        <button 
           onClick={finishWorkout}
           disabled={!sessionStartTime}
           className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 mb-8 transition-all ${
             sessionStartTime 
               ? 'bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-200 active:scale-95 cursor-pointer'
               : 'bg-slate-300 text-slate-500 cursor-not-allowed opacity-50'
           }`}
        >
           <Save size={24} />
           {sessionStartTime ? "Finalizar Treino de Hoje" : "Inicie o treino primeiro"}
        </button>

      </div>

      {/* Floating Timer */}
      <div className="fixed bottom-4 left-4 right-4 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between z-50">
        <div className="flex items-center gap-3">
           <div className={`p-2 rounded-full ${isTimerRunning ? 'bg-emerald-500 animate-pulse' : 'bg-slate-700'}`}>
              <Clock size={20} />
           </div>
           <div>
             <div className="text-xs text-slate-400 uppercase font-bold tracking-wider">Descanso</div>
             <div className="text-2xl font-mono font-bold leading-none">{timeLeft}s</div>
           </div>
        </div>
        <div className="flex gap-2">
           <button 
             onClick={toggleTimer}
             className="bg-white text-slate-900 px-4 py-2 rounded-lg font-bold text-sm active:scale-95 transition-transform"
           >
             {isTimerRunning ? 'Pausar' : 'Iniciar'}
           </button>
           <button 
             onClick={resetTimer}
             className="bg-slate-700 text-white p-2 rounded-lg active:scale-95 transition-transform"
           >
             ↻
           </button>
        </div>
      </div>
    </div>
  );
}